<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <head>
        <title>Mi Carrito</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    </head>
    <body class="d-flex flex-column min-vh-100">

        <div th:replace="~{general/fragmentos :: header}"></div>

        <div class="container py-5">
            <h2 class="mb-4">Mi Carrito</h2>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <div th:if="${carrito == null || #lists.isEmpty(carrito.detalles)}" class="alert alert-info">
                Tu carrito está vacío.
            </div>

            <div th:if="${carrito != null && !#lists.isEmpty(carrito.detalles)}">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="det : ${carrito.detalles}">
                            <td class="d-flex align-items-center">
                                <img th:src="@{${det.productos.rutaImagen}}" alt="Producto" class="me-3" style="width:60px; height:60px; object-fit:cover;">
                                <span th:text="${det.productos.nombreProducto}"></span>
                            </td>
                            <td th:text="${'₡ ' + #numbers.formatDecimal(det.productos.precio, 1, 'COMMA', 2, 'POINT')}"></td>
                            <td>
                                <div class="input-group input-group-sm" style="width:100px;">
                                    <button class="btn btn-outline-secondary" type="button"
                                            th:onclick="'decrementQtyCarrito(' + ${det.idDetalle} + ')'">-</button>
                                    <input type="text" class="form-control text-center"
                                           th:id="'qty-cart-' + ${det.idDetalle}" th:value="${det.cantidad}" readonly>
                                    <button class="btn btn-outline-secondary" type="button"
                                            th:onclick="'incrementQtyCarrito(' + ${det.idDetalle} + ',' + ${det.productos.stock} + ')'">+</button>
                                </div>
                            </td>
                            <!-- Subtotal-->
                            <td th:text="${'₡ ' + #numbers.formatDecimal(det.productos.precio.multiply(T(java.math.BigDecimal).valueOf(det.cantidad.doubleValue())), 1, 'COMMA', 2, 'POINT')}"></td>



                            <td>
                                <form th:action="@{/carrito/eliminar}" method="post">
                                    <input type="hidden" name="detalleId" th:value="${det.idDetalle}">
                                    <button type="submit" class="btn btn-danger btn-sm"><i class="fa fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="d-flex justify-content-end align-items-center mt-4">
                    <h5 class="me-4">Total: 
                        <!-- Total -->
                        <span th:text="${'₡ ' + #numbers.formatDecimal(totalCarrito, 1, 'COMMA', 2, 'POINT')}"></span>
                    </h5>
                    <form th:action="@{/carrito/finalizar}" method="post" class="m-0">
                        <button type="submit" class="btn btn-success">Finalizar Compra</button>
                    </form>
                </div>
            </div>
        </div>

        <footer class="mt-auto" th:replace="~{general/fragmentos :: footer}"></footer>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script th:src="@{/js/carrito.js}"></script>

    </body>
</html>
